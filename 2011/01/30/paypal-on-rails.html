<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>PayPal on Rails</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="stylesheet" href="/stylesheets/styles.css">
    <link rel="alternate" type="application/atom+xml"
          href="http://dev.otrobloggeek.com/atom.xml" title="Atom feed">
</head>


  <body>
    <div id="header">
      <div class="container">
        <div class="row">
          <div class="col-md-12">
            <h1><a href="http://dev.otrobloggeek.com">I write code</a></h1>
          </div>
        </div>
      </div>
    </div>

    <div id="content" class="container">
      <div class="row">
        <div class="col-md-9">
          
<div class="post panel panel-default">
    <div class="post-title panel-heading">
        
        <h2><a href="/2011/01/30/paypal-on-rails.html">PayPal on Rails</a></h2>
        
    </div>
    <div class="post-metas panel-body">
        <span class="glyphicon glyphicon-calendar"></span>
30 Jan 2011

<span class="glyphicon glyphicon-tags"></span>
&nbsp;

<span class="label label-info">
    ruby
</span>
&nbsp;


<span class="glyphicon glyphicon-comment"></span>
<a href="http://dev.otrobloggeek.com/2011/01/30/paypal-on-rails.html#disqus_thread">Comments</a>

    </div>
</div>


<div class="post">
    <p>After many searches in Google I found many explanations on how to use PayPal,
however any of them did what I exactly needed. So here&#39;s what I did step by
step last time I needed it.</p>

<h2>How PayPal works</h2>

<p>Take a look at this flow diagram:</p>

<p><img class='img-responsive img-thumbnail' src='/assets/PayPalWPS.jpg '></p>

<ol>
<li>  The buyer goes to PayPal and performs the needed payment. (This is steps
  1 and 2 in the diagram)</li>
<li>  PayPal takes the payment and redirects your buyer back to your
  application.  (steps 3 and 4)</li>
<li>  Some time after that, PayPal will send you a callback response with the
details of the received payment. Your application will use those details to
make sure the payment was OK and mark the order as paid. (Steps 5 and 6)</li>
</ol>

<h2>Set up your PayPal sandbox</h2>

<ul>
<li><p><a href="https://developer.paypal.com">Sign up here</a> To get a sandbox
 account. This account will allow you to handle your development
 tools:</p>

<ul>
<li><em>Seller and buyer mock accounts</em>: That way you can test your payments
without need to use a real account/bank account/credit card.</li>
<li><em>IPN (Instant Payment Notification) testing</em>: This is the way that
PayPal informs your application when the payment is done.</li>
</ul></li>
<li><p>Create a seller and buyer mock accounts. Preconfigured seller
accounts failed for me, they always failed for me 100% of times in a
period of many months. I&#39;m quite sure it&#39;s my fault, but I just
couldn&#39;t find enough info to know what I did wrong.</p></li>
</ul>

<h2>Set up your application</h2>

<h3>Install ActiveMerchant.</h3>

<p>Here it came my second big problem. Just couldn&#39;t figure out how to make it
work in the form of a gem. So I finally had to install it as a plugin.
<code>rails plugin install git://github.com/Shopify/active_merchant.git</code></p>

<p>From the above diagram you application will need to:</p>

<ul>
<li>Be able to send payment details to PayPal.</li>
<li>Receive a callback from PayPal to acknowledge the received payment.</li>
</ul>

<p>And here&#39;s where ActiveMerchant enters. It provides a helper to craft a form
with the needed hidden fields which you will send to PayPal and a class with
the needed logic to receive and validate the callback from PayPal.</p>

<h3>Configure Active Merchant</h3>

<p>Set up an initializer file like <code>config/initializers/active_merchant.rb</code> with
the following content (it explains itself... isn&#39;t it?):</p>

<div><script src='https://gist.github.com/792543.js?file=active_merchant.rb'></script><noscript><pre><code># config/initializer/active_merchant.rb

if Rails.env.production? 
  PAYPAL_ACCOUNT = &#39;production.paypal.account@domain.com&#39;
else
  PAYPAL_ACCOUNT = &#39;test.paypal.account@domain.com&#39;
  ActiveMerchant::Billing::Base.mode = :test
end

</code></pre></noscript></div>

<h3>Set up the PayPal button</h3>

<p>Use something like that to generate the button that your user has to push so
that he makes the payment.</p>

<div><script src='https://gist.github.com/792543.js?file=new.html.erb'></script><noscript><pre><code>&lt;!-- app/views/payment/new.html.erb --&gt;

&lt;% payment_service_for @order.id, PAYPAL_ACCOUNT,
        :amount =&gt; @order.price, :currency =&gt; &#39;EUR&#39;,
        :service =&gt; :paypal do |service|

    service.customer :first_name =&gt; current_user.name,
        :last_name =&gt; current_user.surname,
        :email =&gt; current_user.email

    service.item_name @order.items_summary

    # PayPal will POST a callback here when the payment is done
    service.notify_url notifications_url(@order)
    # PayPal will take your user here with a POST after he pays
    service.return_url paypal_return_notifications_url(@order)
    # PayPal will redirect your user here if he cancels the payment
    service.cancel_return_url paypal_cancel_notifications_url(@order) %&gt;

    &lt;%= submit_tag &#39;Pay this order&#39; %&gt;
&lt;% end %&gt;


</code></pre></noscript></div>

<p>If you need to send more info to PayPal take a look at the ActiveMerchant&#39;s doc
or even at its code, to see which options are accepted by the
<code>payment_service_for</code> helper. Just FYI, the helper doesn&#39;t support multiple
items. In case you need it you&#39;ll need to craft your own helper... and maybe
send a pull request to ActiveMerchant ^^.</p>

<h3>Gather and acknowledge the PayPal response</h3>

<p>PayPal will send you a notification so you can know when the order is paid.
This following code is a sample of how this can be done.</p>

<div><script src='https://gist.github.com/792543.js?file=notifications_controller.rb'></script><noscript><pre><code># app/controllers/notifications_controller.rb

class NotificationsController &lt; ApplicationController
  include ActiveMerchant::Billing::Integrations
  protect_from_forgery :except =&gt; [:create, :paypal_return] 

  # This action is for when the buyer returns to your site from PayPal
  def paypal_return
    flash[:notice] = &quot;Thanks for buying this!&quot;
    redirect_to root_path
  end

  # This action is for when the buyer cancels
  def paypal_cancel
    flash[:notice] = &quot;We&#39;re sorry you didn&#39;t buy :(&quot;
    redirect_to root_path
  end

  # This is what will receive the IPN from PayPal
  def create
    # You maybe want to log this notification
    notify = Paypal::Notification.new request.raw_post
    @order = Order.unpaid.find(notify.item_id)

    if notify.acknowledge
      # Make sure you received the expected payment!
      if notify.complete? and @order.price == BigDecimal.new( params[:mc_gross] )
        # All your bussiness logic goes here
        @order.update_attributes(:paid =&gt; true)
        render :nothing =&gt; true
      end
    rescue
      #Make sure you log the exceptions you have.
    end
  end
end
</code></pre></noscript></div>

<h2>That&#39;s all folks!</h2>

<p>This is the most simple way I found to make PayPal work with ActiveMerchant.
However it&#39;s very limited and lacks support for things like multiple items and
data encryption between your app and PayPal. Unluckly ActiveMerchant lacks
support for these two things on its PayPal integration. However you can achieve
this by using something <a href="http://www.fortytwo.gr/blog/14/Using-Paypal-with-Rails">like that</a>.</p>

<p>If you find some stupid thing or some bug here, just let me know so that I can
fix it :)</p>

</div>

<div class="comments">
    <div id="disqus_thread"></div>
<script type="text/javascript">
 /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
 var disqus_shortname = 'franciscoj';
 var disqus_url = 'http://dev.otrobloggeek.com/2011/01/30/paypal-on-rails.html';
 var disqus_identifier = 'http://dev.otrobloggeek.com/2011/01/30/paypal-on-rails.html';

 /* * * DON'T EDIT BELOW THIS LINE * * */
 (function() {
     var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
     dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
     (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
 })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

</div>

        </div>
      </div>
    </div>

    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
<!-- Latest compiled and minified JavaScript -->
<script src="//netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>

<script type="text/javascript">
/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
var disqus_shortname = 'franciscoj'; // required: replace example with your forum shortname

/* * * DON'T EDIT BELOW THIS LINE * * */
(function () {
var s = document.createElement('script'); s.async = true;
s.type = 'text/javascript';
s.src = 'http://' + disqus_shortname + '.disqus.com/count.js';
(document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
}());
</script>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-18388725-1', 'otrobloggeek.com');
  ga('send', 'pageview');

</script>

  </body>
</html>
